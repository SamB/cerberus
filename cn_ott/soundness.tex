\documentclass[11pt]{article}%

\usepackage{amsmath,amssymb}%
% supertabular package required if using the default grammar tabular
\usepackage{supertabular}
\usepackage[margin=1in]{geometry}


% the un-wrapped (-tex_wrap false) generated LaTeX file for CN
\include{cn_included}
\geometry{a4paper,portrait}
% the package that allows customized layout described in this document
\usepackage{ottlayout}
% the automatically generated file (with our Makefile) to link the generated
% LaTeX with the ottlayout package
\include{cn_override}


\usepackage{pf2}
\beforePfSpace{15pt, 10pt, 10pt, 10pt, 5pt, 2pt}
\afterPfSpace{15pt, 10pt, 10pt, 10pt, 5pt, 2pt}
\interStepSpace{15pt, 10pt, 10pt, 10pt, 5pt, 2pt}
\pflongindent%


\newcommand{\ctxC}{\mathcal{C}}%
\newcommand{\ctxL}{\mathcal{L}}%
\newcommand{\ctxN}{\Phi}%
\newcommand{\ctxR}{\mathcal{R}}%
\newcommand{\stepsto}{\longrightarrow}%
\newcommand{\reducesto}{\mathrel{{\longrightarrow}^\ast}}%
\newcommand{\checks}{\Leftarrow}%
%\newcommand{\implies}{\Rightarrow}%
\newcommand{\synths}{\Rightarrow}%
\newcommand{\conf}[1]{\langle #1 \rangle}%
\newcommand{\sych}{\Leftrightarrow}%
\newcommand{\hconf}[2]{\langle #1 ; #2 \rangle}%
\newcommand{\lolly}{\multimap}

\title{Explicit CN Soundness Proof}
\author{Dhruv Makwana}

\begin{document}
\ottstyledefaults{premiselayout=justify}%

\maketitle

\section{Weakening}

If $\ctxC ; \ctxL ; \ctxN ; \ctxR \sqsubseteq \ctxC' ; \ctxL' ; \ctxN' ;
\ctxR'$ and $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash J$ then $\ctxC' ; \ctxL' ;
\ctxN' ; \ctxR' \vdash J$.

\begin{proof}
    \pfsketch{ Induction over the typing judgements.\\}

    \assume{%
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \sqsubseteq \ctxC' ; \ctxL' ; \ctxN' ; \ctxR'$
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash J$\\
        \end{pfenum}
    }

    \prove{$\ctxC' ; \ctxL' ; \ctxN' ; \ctxR' \vdash J$.}
\end{proof}

\section{Substitution}

\subsection{Weakening for Substitution}

Weakening for substitution: as above, but with $J= ( \sigma ) : ( \ctxC'' ;
\ctxL'' ; \ctxN'' ; \ctxR'' )$.

\begin{proof}
    \pfsketch{ Induction over the substitution.\\}

    \assume{%
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \sqsubseteq \ctxC' ; \ctxL' ; \ctxN' ; \ctxR'$
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC'' ; \ctxL'' ; \ctxN'' ; \ctxR'' )$\\
        \end{pfenum}
    }

    \prove{$\ctxC' ; \ctxL' ; \ctxN' ; \ctxR' \vdash ( \sigma ) : ( \ctxC'' ; \ctxL'' ; \ctxN'' ; \ctxR'' )$.}
\end{proof}

\subsection{Substitution Lemma}

If $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC' ; \ctxL' ;
\ctxN' ; \ctxR')$ and $\ctxC' ; \ctxL' ; \ctxN' ; \ctxR' \vdash J$ then $\ctxC
; \ctxL ; \ctxN ; \ctxR \vdash \sigma ( J )$. 

\begin{proof}
    \pfsketch{ Induction over the typing judgements.\\}

    \assume{%
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC' ; \ctxL' ; \ctxN' ; \ctxR')$
            \item $\ctxC' ; \ctxL' ; \ctxN' ; \ctxR' \vdash J$\\
        \end{pfenum}
    }

    \prove{$\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash \sigma ( J )$.}

    \step{<1>1}{%
        \case{%
            \textsc{Ty\_PVal\_Var}.
        }{%
            $\ctxC' ; \ctxL' ; \ctxN' \vdash x \synths \beta$
        }
    }

    \begin{proof}
        \step{<2>1}{Have $x : \beta \in \ctxC'$ (or $x : \beta \in \ctxL'$).}
        \step{<2>3}{So $\exists pval.\ \ctxC ; \ctxL ; \ctxN \vdash pval \synths
            \beta$ by \textsc{Ty\_Subs\_Cons\_\{Comp,Log\}}.}
        \step{<2>4}{Since $pval = \sigma(x)$, we are done.}
    \end{proof}

    \step{<1>1}{%
        \case{%
            \textsc{Ty\_TPE\_Let}.
        }{%
            $\ctxC' ; \ctxL' ; \ctxN' \vdash \cnkw{let } pat = pexpr \cnkw{ in
            } tpexpr \checks y_2 : \beta_2.\ term_2$
        }
    }

    \begin{proof}
        \step{<2>1}{By induction,
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN \vdash \sigma ( pexpr ) \synths y_1 :
                \beta_1 .\ \sigma ( term_1 )$\label{IH1}
            \item $\ctxC , \ctxC_1 ; \ctxL , y_1 : \beta_1 ; \ctxN , term_1 ,
                \ctxN' \vdash \sigma (tpexpr ) \checks y_2 : \beta_2.\ \sigma (
                term_2 )$\label{IH2}.
        \end{pfenum}}\pflabel{IH}

        \step{<2>2}{$\ctxC ; \ctxL ; \ctxN \vdash \sigma ( \cnkw{let } pat =
            pexpr \cnkw{ in } tpexpr \checks y_2 : \beta_2.\ term_2 )$ as required.}
    \end{proof}

    \step{<1>1}{%
        \case{%
            \textsc{Ty\_TVal\_Log}.
        }{%
            $\ctxC' ; \ctxL' ; \ctxN' ; \ctxR' \vdash \cnkw{done } pval ,
            \overline{spine\_elem} \checks \exists y : \beta.\ ret$
        }
    }

    \begin{proof}
        \step{<2>1}{By inversion and then induction,
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN \vdash \sigma ( pval ) \beta$\label{IH1}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash \sigma ( \cnkw{done }
                \overline{spine\_elem} ) \checks \sigma ( [ pval / y ] ret )$\label{IH2}.
        \end{pfenum}}\pflabel{IH}

        \step{<2>2}{Therefore $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash \sigma (
            \cnkw{done } pval , \overline{spine\_elem} \checks \exists y :
        \beta . ret )$.}
    \end{proof}

    \step{<1>1}{%
        \case{%
            \textsc{Ty\_Spine\_Res}.
        }{%
            $\ctxC' ; \ctxL' ; \ctxN' ; \ctxR_1' , \ctxR_2 \vdash x = res\_term ,
            \overline{ x = spine\_elem } \mathrel{{:}{:}} res \lolly arg \gg
            res\_term / x , \psi ; ret$
        }
    }

    \begin{proof}
        \step{<2>1}{By inversion and then induction,
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR_1 \vdash x = \sigma (
                res\_term  ) \checks \sigma ( res ) $\label{IH1}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR_2 \vdash \overline{x = \sigma (
                spine\_elem )} \mathbin{{:}{:}} \sigma ( res ) \lolly \sigma (
                arg ) \gg \sigma ( \psi ) ; \sigma ( ret )$\label{IH2}
        \end{pfenum}}\pflabel{IH}

        \step{<2>2}{Hence $\ctxC ; \ctxL ; \ctxN ; \ctxR_1 , \ctxR_2 \vdash \sigma (
            x = res\_term , \overline{ x = spine\_elem } \mathrel{{:}{:}} res
            \lolly arg \gg res\_term / x , \psi ; ret )$}
    \end{proof}

\end{proof}

\subsection{Identity Extension}

If $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC' ; \ctxL' ;
\ctxN' ; \ctxR')$ then $\ctxC ; \ctxL ; \ctxN ; \ctxR_1 , \ctxR \vdash ( \sigma
, \mathrm{id} ) : ( \ctxC , \ctxC' ; \ctxL , \ctxL' ; \ctxN , \ctxN' ; \ctxR_1
, \ctxR')$.

\begin{proof}
    \pfsketch{ Induction over the substitution.\\}

    \assume{%
        $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC' ; \ctxL' ; \ctxN' ; \ctxR')$\\
    }

    \prove{%
        $\ctxC ; \ctxL ; \ctxN ; \ctxR_1 , \ctxR \vdash ( \sigma ,
        \mathrm{id} ) : ( \ctxC , \ctxC' ; \ctxL , \ctxL' ; \ctxN , \ctxN' ;
        \ctxR_1 , \ctxR')$.
    }
\end{proof}


\subsection{Usable Substitution Lemma}

If $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC' ; \ctxL' ;
\ctxN' ; \ctxR')$ and $\ctxC , \ctxC' ; \ctxL , \ctxL' ; \ctxN , \ctxN' ;
\ctxR_1 , \ctxR' \vdash J$ then $\ctxC ; \ctxL ; \ctxN ; \ctxR_1 , \ctxR \vdash
\sigma ( J )$.

\begin{proof}
    \pfsketch{ Apply identity extension then substitution lemma.\\}

    \assume{%
        \begin{pfenum}
            \item $\ctxC ; \ctxL ; \ctxN ; \ctxR \vdash ( \sigma ) : ( \ctxC' ; \ctxL' ; \ctxN' ; \ctxR')$
            \item $\ctxC , \ctxC' ; \ctxL , \ctxL' ; \ctxN , \ctxN' ; \ctxR_1 , \ctxR' \vdash J$\\
        \end{pfenum}
    }

    \prove{%
        $\ctxC ; \ctxL ; \ctxN ; \ctxR_1 , \ctxR \vdash \sigma ( J )$.
    }
\end{proof}

\section{Progress}

If $\cdot ; \cdot ; \cdot ; \ctxR \vdash e \sych t$ then
either $\mathrm{value}(e)$ or $\forall h : R.\ \exists e' , h' .\ \hconf{h}{e}
\stepsto \hconf{h'}{e'}$.

\begin{proof}
    \pfsketch{ Induction over the typing rules.\\}

    \assume{%
        $\cdot ; \cdot ; \cdot ; \ctxR \vdash e \sych t$
    }

    \prove{%
        either $\mathrm{value}(e)$ or $\forall h : R.\ \exists e' , h' .\ \hconf{h}{e}
        \stepsto \hconf{h'}{e'}$.
    }
\end{proof}

\section{Framing}

If $\hconf{h_1}{e} \stepsto \hconf{h_1'}{e'}$ and $h_1, h_2$ disjoint then
$\hconf{h_1 + h_2}{e} \stepsto \hconf{h_1' + h_2}{e'}$.

\begin{proof}
    \pfsketch{ Induction over the operational rules.\\}

    \assume{%
        \begin{pfenum}
            \item $\hconf{h_1}{e} \stepsto \hconf{h_1'}{e'}$
            \item $h_1, h_2$ disjoint.\\
        \end{pfenum}
    }

    \prove{%
        $\hconf{h_1 + h_2}{e} \stepsto \hconf{h_1' + h_2}{e'}$.
    }
\end{proof}

\section{Type Preservation}

If $\cdot ; \cdot ; \cdot ; \ctxR \vdash e \sych t$ then
$\forall h : \ctxR, e' , h' : \ctxR' .\ \hconf{h}{e} \stepsto \hconf{h'}{e'}
\implies \cdot ; \cdot ; \cdot ; \ctxR' \vdash e' \sych t$.

\begin{proof}
    \pfsketch{ Induction over the typing rules.\\}

    \assume{%
        \begin{pfenum}
            \item $\cdot ; \cdot ; \cdot ; \ctxR \vdash e \sych t$
            \item arbitrary $h : \ctxR, e' , h' : \ctxR'$
            \item $\hconf{h}{e} \stepsto \hconf{h'}{e'}$.\\
        \end{pfenum}
    }

    \prove{%
        $\cdot ; \cdot ; \cdot ; \ctxR' \vdash e' \sych t$.
    }
\end{proof}

\pagebreak%
\section{Typing Judgements}

\cngrammartabular{
\cnobjectXXvalueXXjtype\cninterrule%
\cnpvalXXjtype\cninterrule%
\cnresXXjtype\cninterrule%
\cnspineXXjtype\cninterrule%
\cnpexprXXjtype\cninterrule%
\cntpvalXXjtype\cninterrule%
\cntpexprXXjtype\cninterrule%
\cnactionXXjtype\cninterrule%
\cnmemopXXjtype\cninterrule%
\cnseqXXexprXXjtype\cninterrule%
\cnisXXexprXXjtype\cninterrule%
\cntvalXXjtype\cninterrule%
\cntexprXXjtype\cninterrule%
}

\pagebreak%
\section{Opsem Judgements}

\cngrammartabular{
\cnpureXXopsemXXjtype\cninterrule%
\cnopsemXXjtype\cninterrule%
}


\end{document}
